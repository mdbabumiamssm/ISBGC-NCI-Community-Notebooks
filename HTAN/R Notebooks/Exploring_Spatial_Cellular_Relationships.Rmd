---
title: "Explore Spatial Cellular and Molecular Relationsips"
author: "Vesteinn Þórsson, (Vesteinn.Thorsson@isbscience.org)"
date: "Created June 1, 2023"
output:
  html_document:
    highlight: tango
    toc: true
    toc_float:
      collapsed: TRUE
      smooth_scroll: false
---
```{r global options, echo = FALSE}
#List other global opts here if relevant
knitr::opts_chunk$set(fig.align="center") #Figures should be centered
```

# 1. Introduction & Overview 

[HTAN](https://humantumoratlas.org/) is a National Cancer Institute (NCI)-funded Cancer MoonshotSM initiative to construct 3-dimensional atlases of the dynamic cellular, morphological, and molecular features of human cancers as they evolve from precancerous lesions to advanced disease. [Cell April 2020](https://www.sciencedirect.com/science/article/pii/S0092867420303469) 

Multiple HTAN centers use highly-multiplexed imaging to gain understanding of cellular and molecular processes at work in the tumor microenvironment.  The study "Multiplexed 3D atlas of state transitions and immune interaction in colorectal cancer", Lin et al

Multiplexed whole-slide imaging analysis characterizes intermixed and graded morphological and molecular features in human colorectal cancer samples, highlighting large-scale cancer characteristic structural features


This notebook shows one example of how data can be accessed and analyzed using R programming software.

### 1.1 Goal

This example notebook illustrates how to make use of HTAN Google BigQuery tables that contain cellular locations and estimated expression of key marker proteins.  

### 1.2 Inputs, Outputs, & Data 

The originating data can be found on the [HTAN Data Portal](https://data.humantumoratlas.org/), and the data tables are on the [Cancer Gateway in the Cloud](https://isb-cgc.appspot.com/).


### 1.3 Notes

The tables correspond to HTAN Data Version 3.

# 2. Environment & Library Setup
```{r}
suppressMessages(library(tidyverse))
suppressMessages(library(bigrquery))
suppressMessages(library(knitr))
```

# 3. Google Authentication

Running the BigQuery cells in this notebook requires a Google Cloud Project, instructions for creating a project can be found in the [Google Documentation](https://cloud.google.com/resource-manager/docs/creating-managing-projects#console). The instance needs to be authorized to bill the project for queries. For more information on getting started in the cloud see 'Quick Start Guide to ISB-CGC' and alternative authentication methods can be found in the [Google Documentation](https://cloud.google.com/resource-manager/docs/creating-managing-projects#console).

```{r eval = FALSE}
billing <- 'my-project' # Insert your project ID in the ''
if (billing == 'my-projectr') {
  print('Please update the project number with your Google Cloud Project')
}
```

# 4. Explore Spatial Cellular and Molecular Relationsips


### 4.1 Look at cell locations

```{r}
df <- read_csv("/Users/vthorsson/HTAN/HMS/coords.csv",show_col_types = FALSE)
```

Number of cells 
```{r}
nrow(df)
```
Plot all centroids. (This may take a few seconds as there are a lot of cells!)
```{r}
ggplot(df, aes(X_centroid,Y_centroid)) +
 geom_point(size=1) +
  theme_classic()
```

### 4.2 Which areas are tumor rich?
```{r}
df <- read_csv("/Users/vthorsson/HTAN/HMS/coords_keratin.csv",show_col_types = FALSE)
df <- df %>% rename(Keratin=Keratin_570_cellRingMask,X=X_centroid,Y=Y_centroid)
```

What is the distribution of Keratin values over all cells?
```{r}
ggplot(df,aes(Keratin)) + geom_histogram(binwidth = 1000) + theme_classic()
```

```{r}
ggplot(df_small, aes(X,Y,fill=Keratin)) +
 geom_point(size=1) + scale_fill_manual()
##+ scale_fill_brewer( palette = "Blues")
  theme_classic()
```
Let's threshold the Keratin as positive above the 3rd quartile.
```{r}
third.quartile <- summary(df$Keratin)[["3rd Qu."]]
df <- df %>% mutate(Keratin_status = c("Neg","Pos")[(Keratin > third.quartile)+1])
```
The generated a new categorical variable, `Keratin_status`, designated as Low or High for every cell.
(A more sophisticated thresholding scheme is employed in the manuscript and described in the coresponding methods section).

Where are the Keratin high cells on the image?
```{r}
ggplot(df, aes(X,Y)) +
 geom_point(aes(color=Keratin_status)) +   scale_color_manual(values=c("gray90","yellow")) +
  theme_classic()
```
As described in the paper, the lower right portion is tumor dominated, and keratin-rich.
### 4.3 Correlations

```{r}
df_small <- slice(df,1:1000)
j <- rdist::pdist(df_small[,c("X","Y")])
jj <- as.dist(j)
b <- dbscan::kNN(jj,10)
```

10 nearest neighbors of the first data point, and the keratin values thereof, and their mean

```{r}
df_small[b$id[1,],"Keratin"]

## Mean of Neighbors
df_small[b$id[1,],"Keratin"] %>% pluck("Keratin") %>% mean()
## The value itself of the first point
df_small[1,"Keratin"] %>% pluck("Keratin")
```
then we do the same for all the other points and calculate the correlation?

# 5. Citations and Links

[Cell April 2020](https://www.sciencedirect.com/science/article/pii/S0092867420303469)

[Multiplexed 3D atlas of state transitions and immune interaction in colorectal cancer](https://www.cell.com/cell/fulltext/S0092-8674(22)01571-9)